\hypertarget{_cool_board_sensors_8cpp_source}{}\section{Cool\+Board\+Sensors.\+cpp}

\begin{DoxyCode}
00001 
00009 \textcolor{preprocessor}{#include "FS.h"}
00010 \textcolor{preprocessor}{#include "Arduino.h"}
00011 \textcolor{preprocessor}{#include <stdint.h>}        
00012 \textcolor{preprocessor}{#include "Wire.h"}
00013 \textcolor{preprocessor}{#include "ArduinoJson.h"}
00014 \textcolor{preprocessor}{#include "\hyperlink{_cool_board_sensors_8h}{CoolBoardSensors.h}"}
00015 
00016 
\Hypertarget{_cool_board_sensors_8cpp_source_l00023}\hyperlink{class_cool_board_sensors_a91ff2a02f5486f90cf2413a1cf8a9ed4}{00023} \hyperlink{class_cool_board_sensors_a91ff2a02f5486f90cf2413a1cf8a9ed4}{CoolBoardSensors::CoolBoardSensors}()
00024 \{
00025     Wire.begin(2, 14);                       \textcolor{comment}{//I2C init Maybe change this to the CoolBoard?}
00026 
00027     pinMode(AnMplex, OUTPUT);                \textcolor{comment}{//Declare Analog Multiplexer OUTPUT}
00028     pinMode(EnMoisture, OUTPUT);             \textcolor{comment}{//Declare Moisture enable Pin}
00029     pinMode(EnI2C, OUTPUT);        \textcolor{comment}{//Declare I2C Enable pin }
00030 
00031 
00032 \}
00033 
\Hypertarget{_cool_board_sensors_8cpp_source_l00041}\hyperlink{class_cool_board_sensors_ab82c2a1633768ccd12a589320fa31a14}{00041} \textcolor{keywordtype}{int} \hyperlink{class_cool_board_sensors_ab82c2a1633768ccd12a589320fa31a14}{CoolBoardSensors::getJsonSize}()
00042 \{
00043     \textcolor{keywordflow}{return}(this->jsonSize );
00044 \}
00045 
\Hypertarget{_cool_board_sensors_8cpp_source_l00051}\hyperlink{class_cool_board_sensors_ab76e6dbd6efbcc25ff460535badd8d45}{00051} \textcolor{keywordtype}{void} \hyperlink{class_cool_board_sensors_ab76e6dbd6efbcc25ff460535badd8d45}{CoolBoardSensors::setJsonSize}(\textcolor{keywordtype}{int} jsonSize)
00052 \{
00053     this->jsonSize=jsonSize;
00054 \}
00055 
\Hypertarget{_cool_board_sensors_8cpp_source_l00062}\hyperlink{class_cool_board_sensors_aa432c5aac88f89c31a10766390f23e0b}{00062} \textcolor{keywordtype}{void} \hyperlink{class_cool_board_sensors_aa432c5aac88f89c31a10766390f23e0b}{CoolBoardSensors::allActive}()
00063 \{
00064     lightDataActive.visible=1;
00065     lightDataActive.ir=1;
00066     lightDataActive.uv=1;   
00067 
00068     airDataActive.temperature=1;
00069     airDataActive.humidity=1;
00070     airDataActive.pressure=1;
00071 
00072 
00073     vbatActive=1;
00074     earthMoistureActive=1;
00075 
00076 
00077 \}
00078 
00079 
\Hypertarget{_cool_board_sensors_8cpp_source_l00085}\hyperlink{class_cool_board_sensors_a97095823ef7c8f5290812f1405b966b3}{00085} \textcolor{keywordtype}{void} \hyperlink{class_cool_board_sensors_a97095823ef7c8f5290812f1405b966b3}{CoolBoardSensors::begin}()
00086 \{       
00087     \hyperlink{class_cool_board_sensors_acad6a8418c66d36868caca23c844ecb6}{initReadI2C}();
00088 
00089     \textcolor{keywordflow}{while} (!\hyperlink{class_cool_board_sensors_a3e397300fb707dd193e909a757bf6102}{lightSensor}.Begin()) \{
00090       Serial.println(\textcolor{stringliteral}{"Si1145 is not ready!  1 second"});
00091       delay(1000);
00092     \}
00093      
00094     this->\hyperlink{class_cool_board_sensors_a406307ffd70272282d91479c7ed8d66f}{setEnvSensorSettings}();
00095     delay(10);  \textcolor{comment}{//Make sure sensor had enough time to turn on. BME280 requires 2ms to start up.}
00096     this->\hyperlink{class_cool_board_sensors_a868e38985e9a2412829fa2790ca13e2e}{envSensor}.begin();
00097     delay(10);  \textcolor{comment}{//Make sure sensor had enough time to turn on. BME280 requires 2ms to start up.}
00098     Serial.println(\hyperlink{class_cool_board_sensors_a868e38985e9a2412829fa2790ca13e2e}{envSensor}.begin(), HEX);
00099 
00100 
00101 \}
00102 
\Hypertarget{_cool_board_sensors_8cpp_source_l00108}\hyperlink{class_cool_board_sensors_a4902b69f6e628bd6557193758fdd2bae}{00108} \textcolor{keywordtype}{void} \hyperlink{class_cool_board_sensors_a4902b69f6e628bd6557193758fdd2bae}{CoolBoardSensors::end}()
00109 \{
00110 
00111     \hyperlink{class_cool_board_sensors_a3e397300fb707dd193e909a757bf6102}{lightSensor}.DeInit();
00112 
00113 \}
00114 
\Hypertarget{_cool_board_sensors_8cpp_source_l00123}\hyperlink{class_cool_board_sensors_a91badb2539d91fda8679f2a597874c48}{00123} String \hyperlink{class_cool_board_sensors_a91badb2539d91fda8679f2a597874c48}{CoolBoardSensors::read}()
00124 \{
00125     String data;
00126     DynamicJsonBuffer  jsonBuffer(jsonSize) ;
00127     JsonObject& root = jsonBuffer.createObject();
00128     
00129     \hyperlink{class_cool_board_sensors_acad6a8418c66d36868caca23c844ecb6}{initReadI2C}();
00130     delay(100);
00131     \textcolor{comment}{//light data}
00132     \textcolor{keywordflow}{if}(lightDataActive.visible)
00133     \{
00134 
00135         root[\textcolor{stringliteral}{"visibleLight"}] =\hyperlink{class_cool_board_sensors_a3e397300fb707dd193e909a757bf6102}{lightSensor}.ReadVisible() ;
00136     \}
00137     
00138     \textcolor{keywordflow}{if}(lightDataActive.ir)
00139     \{
00140         root[\textcolor{stringliteral}{"infraRed"}] = \hyperlink{class_cool_board_sensors_a3e397300fb707dd193e909a757bf6102}{lightSensor}.ReadIR();
00141     \}
00142 
00143     \textcolor{keywordflow}{if}(lightDataActive.uv)
00144     \{
00145         \textcolor{keywordtype}{float} tempUV = (float)\hyperlink{class_cool_board_sensors_a3e397300fb707dd193e909a757bf6102}{lightSensor}.ReadUV()/100 ;
00146         root[\textcolor{stringliteral}{"ultraViolet"}] = tempUV;
00147     \}
00148     
00149     \textcolor{comment}{//BME280 data}
00150     \textcolor{keywordflow}{if}(airDataActive.pressure)  
00151     \{
00152         root[\textcolor{stringliteral}{"Pressure"}] =\hyperlink{class_cool_board_sensors_a868e38985e9a2412829fa2790ca13e2e}{envSensor}.readFloatPressure();
00153     \}
00154     
00155         
00156     \textcolor{keywordflow}{if}(airDataActive.humidity)  
00157     \{   
00158         root[\textcolor{stringliteral}{"Humidity"}] =\hyperlink{class_cool_board_sensors_a868e38985e9a2412829fa2790ca13e2e}{envSensor}.readFloatHumidity() ;
00159     \}   
00160     
00161     \textcolor{keywordflow}{if}(airDataActive.temperature)
00162     \{
00163         root[\textcolor{stringliteral}{"Temperature"}]=\hyperlink{class_cool_board_sensors_a868e38985e9a2412829fa2790ca13e2e}{envSensor}.readTempC();
00164     \}
00165     
00166     \textcolor{comment}{//Vbat}
00167     \textcolor{keywordflow}{if}(vbatActive)  
00168     \{   
00169         root[\textcolor{stringliteral}{"Vbat"}]=this->\hyperlink{class_cool_board_sensors_a6944b6ea7bce8e2fce1b434acfd9d5f3}{readVBat}();
00170     \}
00171     
00172     \textcolor{comment}{//earth Moisture}
00173     \textcolor{keywordflow}{if}(earthMoistureActive)
00174     \{   
00175         root[\textcolor{stringliteral}{"soilMoisture"}]=this->\hyperlink{class_cool_board_sensors_a8761bff50373c485f4465c8db47d0633}{readMoisture}();
00176     \}
00177     
00178     
00179     root.printTo(data);
00180     
00181 
00182 
00183     \textcolor{keywordflow}{return}(data);
00184     
00185 
00186 \}
00187 
\Hypertarget{_cool_board_sensors_8cpp_source_l00193}\hyperlink{class_cool_board_sensors_acad6a8418c66d36868caca23c844ecb6}{00193} \textcolor{keywordtype}{void} \hyperlink{class_cool_board_sensors_acad6a8418c66d36868caca23c844ecb6}{CoolBoardSensors::initReadI2C}()
00194 \{
00195   
00196     digitalWrite(EnI2C,HIGH);\textcolor{comment}{//HIGH= I2C Enable}
00197 
00198 \}
00199 
\Hypertarget{_cool_board_sensors_8cpp_source_l00205}\hyperlink{class_cool_board_sensors_ab67b900b9e5e7c18d52d2d9107ba171b}{00205} \textcolor{keywordtype}{void} \hyperlink{class_cool_board_sensors_ab67b900b9e5e7c18d52d2d9107ba171b}{CoolBoardSensors::stopReadI2C}()
00206 \{
00207 
00208     digitalWrite(EnI2C,LOW);\textcolor{comment}{//HIGH= I2C Enable}
00209 
00210 \}
00211 
00212 
\Hypertarget{_cool_board_sensors_8cpp_source_l00222}\hyperlink{class_cool_board_sensors_a9a218895c5423375c33c08f2c56fb23a}{00222} \textcolor{keywordtype}{bool} \hyperlink{class_cool_board_sensors_a9a218895c5423375c33c08f2c56fb23a}{CoolBoardSensors::config}()
00223 \{
00224     \textcolor{comment}{//read config file}
00225     \textcolor{comment}{//update data}
00226     File coolBoardSensorsConfig = SPIFFS.open(\textcolor{stringliteral}{"/coolBoardSensorsConfig.json"}, \textcolor{stringliteral}{"r"});
00227 
00228     \textcolor{keywordflow}{if} (!coolBoardSensorsConfig) 
00229     \{
00230         \textcolor{keywordflow}{return}(\textcolor{keyword}{false});
00231     \}
00232     \textcolor{keywordflow}{else}
00233     \{
00234         \textcolor{keywordtype}{size\_t} size = coolBoardSensorsConfig.size();
00235         \textcolor{comment}{// Allocate a buffer to store contents of the file.}
00236         std::unique\_ptr<char[]> buf(\textcolor{keyword}{new} \textcolor{keywordtype}{char}[size]);
00237 
00238         coolBoardSensorsConfig.readBytes(buf.get(), size);
00239         DynamicJsonBuffer jsonBuffer;
00240         JsonObject& json = jsonBuffer.parseObject(buf.get());
00241         \textcolor{keywordflow}{if} (!json.success()) 
00242         \{
00243               \textcolor{keywordflow}{return}(\textcolor{keyword}{false});
00244         \} 
00245         \textcolor{keywordflow}{else}
00246         \{     
00247             \textcolor{keywordflow}{if}(json[\textcolor{stringliteral}{"jsonSize"}].success() )
00248             \{
00249                 this->jsonSize = json[\textcolor{stringliteral}{"jsonSize"}]; 
00250             \}
00251             \textcolor{keywordflow}{else}
00252             \{
00253                 this->jsonSize=this->jsonSize;          
00254             \}
00255             json[\textcolor{stringliteral}{"jsonSize"}]=this->jsonSize;
00256 
00257             
00258             \textcolor{keywordflow}{if}(json[\textcolor{stringliteral}{"BME280"}][\textcolor{stringliteral}{"temperature"}].success() )
00259             \{           
00260                 this->airDataActive.temperature=json[\textcolor{stringliteral}{"BME280"}][\textcolor{stringliteral}{"temperature"}];
00261             \}
00262             \textcolor{keywordflow}{else}
00263             \{
00264                 this->airDataActive.temperature=this->airDataActive.temperature;            
00265             \}
00266             json[\textcolor{stringliteral}{"BME280"}][\textcolor{stringliteral}{"temperature"}]=this->airDataActive.temperature;
00267             
00268             
00269             \textcolor{keywordflow}{if}(json[\textcolor{stringliteral}{"BME280"}][\textcolor{stringliteral}{"humidity"}].success() )
00270             \{           
00271             
00272                 this->airDataActive.humidity=json[\textcolor{stringliteral}{"BME280"}][\textcolor{stringliteral}{"humidity"}];
00273             \}
00274             \textcolor{keywordflow}{else}
00275             \{
00276                 this->airDataActive.humidity=this->airDataActive.humidity;
00277             \}
00278             json[\textcolor{stringliteral}{"BME280"}][\textcolor{stringliteral}{"humidity"}]=this->airDataActive.humidity;
00279             
00280             
00281             \textcolor{keywordflow}{if}(json[\textcolor{stringliteral}{"BME280"}][\textcolor{stringliteral}{"pressure"}].success() )
00282             \{
00283                 this->airDataActive.pressure=json[\textcolor{stringliteral}{"BME280"}][\textcolor{stringliteral}{"pressure"}];
00284             \}
00285             \textcolor{keywordflow}{else}
00286             \{
00287                 this->airDataActive.pressure=this->airDataActive.pressure;
00288             \}
00289             json[\textcolor{stringliteral}{"BME280"}][\textcolor{stringliteral}{"pressure"}]=this->airDataActive.pressure;
00290 
00291             
00292             \textcolor{keywordflow}{if}(json[\textcolor{stringliteral}{"SI114X"}][\textcolor{stringliteral}{"visible"}].success() )
00293             \{
00294                 this->lightDataActive.visible=json[\textcolor{stringliteral}{"SI114X"}][\textcolor{stringliteral}{"visible"}];
00295             \}
00296             \textcolor{keywordflow}{else}
00297             \{
00298                 this->lightDataActive.visible=this->lightDataActive.visible;
00299             \}
00300             json[\textcolor{stringliteral}{"SI114X"}][\textcolor{stringliteral}{"visible"}]=this->lightDataActive.visible;
00301             
00302             
00303             \textcolor{keywordflow}{if}(json[\textcolor{stringliteral}{"SI114X"}][\textcolor{stringliteral}{"ir"}].success() )
00304             \{           
00305                 this->lightDataActive.ir=json[\textcolor{stringliteral}{"SI114X"}][\textcolor{stringliteral}{"ir"}];
00306             \}
00307             \textcolor{keywordflow}{else}
00308             \{
00309                 this->lightDataActive.ir=this->lightDataActive.ir;
00310             \}
00311             json[\textcolor{stringliteral}{"SI114X"}][\textcolor{stringliteral}{"ir"}]=this->lightDataActive.ir;
00312 
00313             
00314             \textcolor{keywordflow}{if}(json[\textcolor{stringliteral}{"SI114X"}][\textcolor{stringliteral}{"uv"}].success() )         
00315             \{           
00316                 this->lightDataActive.uv=json[\textcolor{stringliteral}{"SI114X"}][\textcolor{stringliteral}{"uv"}];
00317             \}
00318             \textcolor{keywordflow}{else}
00319             \{
00320                 this->lightDataActive.uv=this->lightDataActive.uv;
00321             \}
00322             json[\textcolor{stringliteral}{"SI114X"}][\textcolor{stringliteral}{"uv"}]=this->lightDataActive.uv;
00323 
00324 
00325             \textcolor{keywordflow}{if}(json[\textcolor{stringliteral}{"vbat"}].success() )
00326             \{
00327                 this->vbatActive=json[\textcolor{stringliteral}{"vbat"}];
00328             \}
00329             \textcolor{keywordflow}{else}
00330             \{
00331                 this->vbatActive=this->vbatActive;
00332             \}
00333             json[\textcolor{stringliteral}{"vbat"}]=this->vbatActive;
00334 
00335             
00336             \textcolor{keywordflow}{if}(json[\textcolor{stringliteral}{"soilMoisture"}].success() )
00337             \{           
00338                 this->earthMoistureActive= json[\textcolor{stringliteral}{"soilMoisture"}];
00339             \}
00340             \textcolor{keywordflow}{else}
00341             \{
00342                 this->earthMoistureActive=this->earthMoistureActive;
00343             \}
00344             json[\textcolor{stringliteral}{"soilMoisture"}]=this->earthMoistureActive;
00345 
00346             coolBoardSensorsConfig.close();         
00347             coolBoardSensorsConfig = SPIFFS.open(\textcolor{stringliteral}{"/coolBoardSensorsConfig.json"}, \textcolor{stringliteral}{"w"});          
00348             \textcolor{keywordflow}{if}(!coolBoardSensorsConfig)
00349             \{
00350                 \textcolor{keywordflow}{return}(\textcolor{keyword}{false});          
00351             \}  
00352 
00353             json.printTo(coolBoardSensorsConfig);
00354             coolBoardSensorsConfig.close();         
00355             
00356               \textcolor{keywordflow}{return}(\textcolor{keyword}{true}); 
00357         \}
00358     \}   
00359 
00360 \}
00361 
00362 
\Hypertarget{_cool_board_sensors_8cpp_source_l00368}\hyperlink{class_cool_board_sensors_af6fd79505815b204c178617ecf54c873}{00368} \textcolor{keywordtype}{void} \hyperlink{class_cool_board_sensors_af6fd79505815b204c178617ecf54c873}{CoolBoardSensors::printConf}()
00369 \{
00370     Serial.println(\textcolor{stringliteral}{"Sensors Conf "});
00371     Serial.println(jsonSize);
00372     Serial.println(airDataActive.temperature);
00373     Serial.println(airDataActive.humidity);
00374     Serial.println(airDataActive.pressure);
00375 
00376     Serial.println(lightDataActive.visible);
00377     Serial.println(lightDataActive.ir);
00378     Serial.println(lightDataActive.uv);
00379     Serial.println(vbatActive);
00380     Serial.println(earthMoistureActive);
00381     Serial.println(\textcolor{stringliteral}{" "});
00382 \}
00383 
00384 
\Hypertarget{_cool_board_sensors_8cpp_source_l00391}\hyperlink{class_cool_board_sensors_a406307ffd70272282d91479c7ed8d66f}{00391} \textcolor{keywordtype}{void} \hyperlink{class_cool_board_sensors_a406307ffd70272282d91479c7ed8d66f}{CoolBoardSensors::setEnvSensorSettings}( uint8\_t commInterface, 
      uint8\_t I2CAddress,    
00392 
00393                            uint8\_t runMode , uint8\_t tStandby, uint8\_t filter,                         
00394                            uint8\_t tempOverSample,  uint8\_t pressOverSample,                                
         
00395                            uint8\_t humidOverSample)
00396 \{
00397   \hyperlink{class_cool_board_sensors_a868e38985e9a2412829fa2790ca13e2e}{envSensor}.settings.commInterface = commInterface;      
00398   
00399   \hyperlink{class_cool_board_sensors_a868e38985e9a2412829fa2790ca13e2e}{envSensor}.settings.I2CAddress = I2CAddress;
00400   
00401   \hyperlink{class_cool_board_sensors_a868e38985e9a2412829fa2790ca13e2e}{envSensor}.settings.runMode = runMode; 
00402   
00403   \hyperlink{class_cool_board_sensors_a868e38985e9a2412829fa2790ca13e2e}{envSensor}.settings.tStandby = tStandby; 
00404   
00405   \hyperlink{class_cool_board_sensors_a868e38985e9a2412829fa2790ca13e2e}{envSensor}.settings.filter = filter; 
00406   
00407   \hyperlink{class_cool_board_sensors_a868e38985e9a2412829fa2790ca13e2e}{envSensor}.settings.tempOverSample = tempOverSample;
00408   
00409   \hyperlink{class_cool_board_sensors_a868e38985e9a2412829fa2790ca13e2e}{envSensor}.settings.pressOverSample = pressOverSample;
00410   
00411   \hyperlink{class_cool_board_sensors_a868e38985e9a2412829fa2790ca13e2e}{envSensor}.settings.humidOverSample = humidOverSample;
00412 
00413 \}
00414 
\Hypertarget{_cool_board_sensors_8cpp_source_l00423}\hyperlink{class_cool_board_sensors_a6944b6ea7bce8e2fce1b434acfd9d5f3}{00423} \textcolor{keywordtype}{float} \hyperlink{class_cool_board_sensors_a6944b6ea7bce8e2fce1b434acfd9d5f3}{CoolBoardSensors::readVBat}()
00424 \{
00425     digitalWrite(AnMplex, LOW);                                  \textcolor{comment}{//Enable Analog Switch to get the batterie
       tension}
00426     
00427     delay(200);
00428     
00429     \textcolor{keywordtype}{int} raw = analogRead(A0);                                    \textcolor{comment}{//read in batterie tension}
00430     
00431     \textcolor{keywordtype}{float} val = 6.04 / 1024 * raw;                               \textcolor{comment}{//convert it apprimatly right tension in
       volts}
00432 
00433     \textcolor{keywordflow}{return} (val);   
00434 \}
00435 
\Hypertarget{_cool_board_sensors_8cpp_source_l00444}\hyperlink{class_cool_board_sensors_a8761bff50373c485f4465c8db47d0633}{00444} \textcolor{keywordtype}{float} \hyperlink{class_cool_board_sensors_a8761bff50373c485f4465c8db47d0633}{CoolBoardSensors::readMoisture}()
00445 \{
00446       digitalWrite(EnMoisture, LOW);                 \textcolor{comment}{//enable moisture sensor and waith a bit}
00447       
00448       digitalWrite(AnMplex, HIGH);          \textcolor{comment}{//enable analog Switch to get the moisture}
00449       
00450       delay(2000);
00451       
00452       \textcolor{keywordtype}{int} val = analogRead(A0);                       \textcolor{comment}{//read the value form the moisture sensor}
00453       
00454       \textcolor{keywordtype}{float} result = (float)map(val, 0, 890, 0, 100);   
00455 
00456       digitalWrite(EnMoisture, HIGH);                  \textcolor{comment}{//disable moisture sensor for minimum wear}
00457       
00458       \textcolor{keywordflow}{return} (result);
00459 \}
00460 
\end{DoxyCode}
