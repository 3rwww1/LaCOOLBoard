\hypertarget{_cool_m_q_t_t_8cpp_source}{}\section{Cool\+M\+Q\+T\+T.\+cpp}

\begin{DoxyCode}
00001 
00011 \textcolor{preprocessor}{#include "FS.h"}
00012 \textcolor{preprocessor}{#include "Arduino.h"}  
00013 \textcolor{preprocessor}{#include <ESP8266WiFi.h>}
00014 \textcolor{preprocessor}{#include <PubSubClient.h>}                             
00015 \textcolor{preprocessor}{#include "\hyperlink{_cool_m_q_t_t_8h}{CoolMQTT.h}"}
00016 \textcolor{preprocessor}{#include "ArduinoJson.h"}
00017 
\Hypertarget{_cool_m_q_t_t_8cpp_source_l00026}\hyperlink{class_cool_m_q_t_t_ac9248808641ebf3054ed0620ea9d0100}{00026} \textcolor{keywordtype}{void} \hyperlink{class_cool_m_q_t_t_ac9248808641ebf3054ed0620ea9d0100}{CoolMQTT::begin}()
00027 \{ 
00028     client.setClient(espClient);
00029     client.setServer(mqttServer, 1883); 
00030     client.setCallback([\textcolor{keyword}{this}] (\textcolor{keywordtype}{char}* topic, byte* payload, \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} length) \{ this->
      \hyperlink{class_cool_m_q_t_t_a30d82ad665bfb603f46ecdbc290775df}{callback}(topic, payload, length); \});
00031     client.setBufferSize((\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{short})bufferSize);
00032 
00033 \}
00034 
\Hypertarget{_cool_m_q_t_t_8cpp_source_l00051}\hyperlink{class_cool_m_q_t_t_a5d003307eff78efbd585e42b43b72b6d}{00051} \textcolor{keywordtype}{int} \hyperlink{class_cool_m_q_t_t_a5d003307eff78efbd585e42b43b72b6d}{CoolMQTT::state}()
00052 \{
00053     \textcolor{keywordflow}{return}(client.state());
00054 \}
00055 
\Hypertarget{_cool_m_q_t_t_8cpp_source_l00064}\hyperlink{class_cool_m_q_t_t_a58b0b1f64b269c2681685208262fba1d}{00064} \textcolor{keywordtype}{int} \hyperlink{class_cool_m_q_t_t_a58b0b1f64b269c2681685208262fba1d}{CoolMQTT::connect}(uint16\_t keepAlive)
00065 \{       
00066     \textcolor{keywordtype}{int} i=0;
00067     Serial.println(\textcolor{stringliteral}{"MQTT connecting..."});
00068     \textcolor{keywordflow}{while} ((!client.connected())&&(i<100)) 
00069     \{
00070         \textcolor{comment}{// Attempt to connect}
00071         \textcolor{keywordflow}{if} (client.connect(user,keepAlive)) \{
00072             Serial.println(\textcolor{stringliteral}{"connected"});
00073             \textcolor{comment}{// Once connected, publish an announcement...}
00074             \textcolor{comment}{//client.publish(outTopic, "hello world by Ash");}
00075             \textcolor{comment}{// ... and resubscribe}
00076             client.subscribe(inTopic);
00077             Serial.println(\textcolor{stringliteral}{"published and subscribed , leavin "}) ;
00078             \textcolor{keywordflow}{return}(client.state());
00079         \}
00080         \textcolor{keywordflow}{else}
00081         \{
00082             Serial.println(\textcolor{stringliteral}{"not connected , leaving"});
00083             \textcolor{keywordflow}{return}(client.state());
00084             
00085         \}
00086     delay(5);
00087     i++;
00088     \}
00089     
00090     \textcolor{keywordflow}{return}(1);
00091 
00092 \}
00093 
\Hypertarget{_cool_m_q_t_t_8cpp_source_l00102}\hyperlink{class_cool_m_q_t_t_ace977b3e90ab14b1199fe5c4fb0a13ec}{00102} \textcolor{keywordtype}{bool} \hyperlink{class_cool_m_q_t_t_ace977b3e90ab14b1199fe5c4fb0a13ec}{CoolMQTT::publish}(\textcolor{keyword}{const} \textcolor{keywordtype}{char}* data)
00103 \{
00104 
00105     \textcolor{comment}{//data is in JSON, publish it directly}
00106 
00107     Serial.println(\textcolor{stringliteral}{"data to publish"});
00108     Serial.println(data);
00109     Serial.print(\textcolor{stringliteral}{"data size "});Serial.println(strlen(data));
00110     \textcolor{keywordtype}{bool} pub=client.publish( outTopic, data,strlen(data) );
00111 
00112 
00113     \textcolor{keywordflow}{return}( pub);
00114 
00115 \}
00116 
\Hypertarget{_cool_m_q_t_t_8cpp_source_l00125}\hyperlink{class_cool_m_q_t_t_a65a506641740ce797ceadd4fa8a286d3}{00125} \textcolor{keywordtype}{bool} \hyperlink{class_cool_m_q_t_t_ace977b3e90ab14b1199fe5c4fb0a13ec}{CoolMQTT::publish}(\textcolor{keyword}{const} \textcolor{keywordtype}{char}* data,\textcolor{keywordtype}{int} logInterval)
00126 \{
00127     \textcolor{keywordflow}{if}( (millis()-this->previousLogTime) >=( logInterval ) )
00128     \{
00129         this->\hyperlink{class_cool_m_q_t_t_ace977b3e90ab14b1199fe5c4fb0a13ec}{publish}(data);
00130 
00131         this->previousLogTime=millis();
00132 
00133         \textcolor{keywordflow}{return}(\textcolor{keyword}{true});
00134     \}
00135     
00136     \textcolor{keywordflow}{return}(\textcolor{keyword}{false});
00137 \}
00138 
\Hypertarget{_cool_m_q_t_t_8cpp_source_l00147}\hyperlink{class_cool_m_q_t_t_aa5eaae967b562b62cbcf2b8d81f6e5d5}{00147} \textcolor{keywordtype}{bool} \hyperlink{class_cool_m_q_t_t_aa5eaae967b562b62cbcf2b8d81f6e5d5}{CoolMQTT::mqttLoop}()
00148 \{
00149     this->client.loop();
00150     \textcolor{keywordflow}{return}(client.loop());
00151 \}
00152 
\Hypertarget{_cool_m_q_t_t_8cpp_source_l00160}\hyperlink{class_cool_m_q_t_t_a30d82ad665bfb603f46ecdbc290775df}{00160} \textcolor{keywordtype}{void} \hyperlink{class_cool_m_q_t_t_a30d82ad665bfb603f46ecdbc290775df}{CoolMQTT::callback}(\textcolor{keywordtype}{char}* topic, byte* payload, \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} length) 
00161 \{
00162     \textcolor{keywordtype}{char} \hyperlink{_irene3000_8h_a5905d48604152cf57aa6bfa087b49173}{temp}[length+1];
00163 
00164     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < length; i++) 
00165     \{
00166         temp[i]=(char)payload[i]; 
00167 
00168     \}
00169 
00170     this->newMsg=\textcolor{keyword}{true};
00171 
00172     temp[length+1]=\textcolor{charliteral}{'\(\backslash\)0'};
00173 
00174     msg=String(temp);
00175     msg.remove(length,1);
00176     Serial.println(\textcolor{stringliteral}{"received"});
00177     Serial.println(msg);
00178 
00179 \}
00180 
\Hypertarget{_cool_m_q_t_t_8cpp_source_l00186}\hyperlink{class_cool_m_q_t_t_ae3c18f6ae9723746d32765f1c8f176ca}{00186} String \hyperlink{class_cool_m_q_t_t_ae3c18f6ae9723746d32765f1c8f176ca}{CoolMQTT::read}()
00187 \{   
00188     \textcolor{keywordflow}{if}(this->newMsg==\textcolor{keyword}{true})
00189     \{
00190         \textcolor{keywordflow}{return}(this->msg);
00191         this->newMsg=\textcolor{keyword}{false};
00192     \}
00193     \textcolor{keywordflow}{return}(\textcolor{stringliteral}{" "});
00194 
00195 \}
00196 
\Hypertarget{_cool_m_q_t_t_8cpp_source_l00208}\hyperlink{class_cool_m_q_t_t_a6571671781a505feca9a8a56e256c6bc}{00208} \textcolor{keywordtype}{bool} \hyperlink{class_cool_m_q_t_t_a6571671781a505feca9a8a56e256c6bc}{CoolMQTT::config}()
00209 \{
00210     \textcolor{comment}{//read config file}
00211     \textcolor{comment}{//update data}
00212     File configFile = SPIFFS.open(\textcolor{stringliteral}{"/mqttConfig.json"}, \textcolor{stringliteral}{"r"});
00213 
00214     \textcolor{keywordflow}{if} (!configFile) 
00215     \{
00216         \textcolor{keywordflow}{return}(\textcolor{keyword}{false});
00217     \}
00218     \textcolor{keywordflow}{else}
00219     \{
00220         \textcolor{keywordtype}{size\_t} size = configFile.size();
00221         \textcolor{comment}{// Allocate a buffer to store contents of the file.}
00222         std::unique\_ptr<char[]> buf(\textcolor{keyword}{new} \textcolor{keywordtype}{char}[size]);
00223 
00224         configFile.readBytes(buf.get(), size);
00225         DynamicJsonBuffer jsonBuffer;
00226         JsonObject& json = jsonBuffer.parseObject(buf.get());
00227         \textcolor{keywordflow}{if} (!json.success()) 
00228         \{
00229               \textcolor{keywordflow}{return}(\textcolor{keyword}{false});
00230         \} 
00231         \textcolor{keywordflow}{else}
00232         \{               
00233                 \textcolor{keywordflow}{if}(json[\textcolor{stringliteral}{"mqttServer"}].success() )
00234                 \{           
00235                     \textcolor{keyword}{const} \textcolor{keywordtype}{char}* tempmqttServer = json[\textcolor{stringliteral}{"mqttServer"}]; \textcolor{comment}{// "inTopic"}
00236                     \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} i =0;i< 50 ;i++)
00237                     \{
00238                         mqttServer[i]=tempmqttServer[i];
00239                     \}
00240                 \}
00241                 \textcolor{keywordflow}{else}
00242                 \{
00243                     \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} i =0;i< 50 ;i++)
00244                     \{
00245                         this->mqttServer[i]=this->mqttServer[i];
00246                     \}
00247 
00248                 \}
00249                 json[\textcolor{stringliteral}{"mqttServer"}]=this->mqttServer;
00250 
00251                 
00252                 \textcolor{keywordflow}{if}(json[\textcolor{stringliteral}{"inTopic"}].success() )
00253                 \{
00254                     \textcolor{keyword}{const} \textcolor{keywordtype}{char}* tempInTopic = json[\textcolor{stringliteral}{"inTopic"}]; \textcolor{comment}{// "inTopic"}
00255                     \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} i =0;i< 50;i++)
00256                     \{
00257                         inTopic[i]=tempInTopic[i];
00258                     \}
00259                 \}
00260                 \textcolor{keywordflow}{else}
00261                 \{
00262                     String tempMAC = WiFi.macAddress();
00263                     tempMAC.replace(\textcolor{stringliteral}{":"},\textcolor{stringliteral}{""});
00264                     snprintf(inTopic, 50, \textcolor{stringliteral}{"$aws/things/%s/shadow/update/delta"}, tempMAC.c\_str());   
00265                     Serial.print(\textcolor{stringliteral}{"Set Incomming MQTT Channel to : "});
00266                     Serial.println(inTopic);    
00267                 \}
00268                 json[\textcolor{stringliteral}{"inTopic"}]=this->inTopic;
00269                 
00270                 
00271                 \textcolor{keywordflow}{if}(json[\textcolor{stringliteral}{"outTopic"}].success() )
00272                 \{
00273                     \textcolor{keyword}{const} \textcolor{keywordtype}{char}* tempOutTopic = json[\textcolor{stringliteral}{"outTopic"}]; \textcolor{comment}{// "outTopic"}
00274                     \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} i =0;i<50;i++)
00275                     \{
00276                         outTopic[i]=tempOutTopic[i];
00277                     \}
00278                 \}
00279                 \textcolor{keywordflow}{else}
00280                 \{
00281                     String tempMAC = WiFi.macAddress();
00282                     tempMAC.replace(\textcolor{stringliteral}{":"},\textcolor{stringliteral}{""});
00283                     snprintf(outTopic, 50, \textcolor{stringliteral}{"$aws/things/%s/shadow/update"}, tempMAC.c\_str());
00284                     Serial.print(\textcolor{stringliteral}{"Set Outgoing MQTT Channel to : "});
00285                     Serial.println(outTopic);
00286                 \}
00287                 json[\textcolor{stringliteral}{"outTopic"}]=this->outTopic;
00288             
00289                 
00290                 \textcolor{keywordflow}{if}(json[\textcolor{stringliteral}{"user"}].success() )
00291                 \{               
00292                     \textcolor{keyword}{const} \textcolor{keywordtype}{char}* tempUser = json[\textcolor{stringliteral}{"user"}]; 
00293                     \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} i =0;i<50;i++)
00294                     \{
00295                         user[i]=tempUser[i];
00296                     \}
00297                 \}
00298                 \textcolor{keywordflow}{else}
00299                 \{
00300                     \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} i=0;i<50;i++)
00301                     \{
00302                         this->user[i]=this->user[i];
00303                     \}               
00304                 \}
00305                 json[\textcolor{stringliteral}{"user"}]=this->user;
00306                 
00307                 \textcolor{keywordflow}{if}(json[\textcolor{stringliteral}{"bufferSize"}].success() )
00308                 \{
00309                     \textcolor{keywordtype}{int} tempBufferSize = json[\textcolor{stringliteral}{"bufferSize"}]; \textcolor{comment}{// 512}
00310                     bufferSize=tempBufferSize;
00311                 \}
00312                 \textcolor{keywordflow}{else}
00313                 \{
00314                     this->bufferSize=this->bufferSize;
00315                 \}
00316                 json[\textcolor{stringliteral}{"bufferSize"}]=this->bufferSize;
00317 
00318                 configFile.close();
00319                 configFile = SPIFFS.open(\textcolor{stringliteral}{"/mqttConfig.json"}, \textcolor{stringliteral}{"w"});
00320                 \textcolor{keywordflow}{if}(!configFile)
00321                 \{
00322                     \textcolor{keywordflow}{return}(\textcolor{keyword}{false});              
00323                 \}
00324                 
00325                 json.printTo(configFile);
00326                 configFile.close();
00327               
00328               \textcolor{keywordflow}{return}(\textcolor{keyword}{true}); 
00329         \}
00330     \}   
00331     
00332 
00333 \}
00334 
\Hypertarget{_cool_m_q_t_t_8cpp_source_l00340}\hyperlink{class_cool_m_q_t_t_a9b703de4f1358f0ee7a5e8c44979c648}{00340} \textcolor{keywordtype}{void} \hyperlink{class_cool_m_q_t_t_a6571671781a505feca9a8a56e256c6bc}{CoolMQTT::config}(\textcolor{keyword}{const} \textcolor{keywordtype}{char} mqttServer[],\textcolor{keyword}{const} \textcolor{keywordtype}{char} inTopic[],\textcolor{keyword}{const} \textcolor{keywordtype}{char} outTopic[],\textcolor{keyword}{
      const} \textcolor{keywordtype}{char} user[],\textcolor{keywordtype}{int} bufferSize)
00341 \{
00342     \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} i =0;i< 50 ;i++)
00343     \{
00344         this->mqttServer[i]=mqttServer[i];
00345         this->inTopic[i]=inTopic[i];
00346         this->outTopic[i]=outTopic[i];
00347         this->user[i]=user[i];
00348     \}
00349     this->bufferSize=bufferSize;
00350 
00351 \}
00352 
\Hypertarget{_cool_m_q_t_t_8cpp_source_l00358}\hyperlink{class_cool_m_q_t_t_a40553a0ad4b5ecf1cb4411ab54ca85fb}{00358} \textcolor{keywordtype}{void} \hyperlink{class_cool_m_q_t_t_a40553a0ad4b5ecf1cb4411ab54ca85fb}{CoolMQTT::printConf}()
00359 \{
00360     Serial.println(\textcolor{stringliteral}{"MQTT conf "});
00361     Serial.println(mqttServer);
00362     Serial.println(inTopic);
00363     Serial.println(outTopic);
00364     Serial.println(user);
00365     Serial.println(bufferSize);
00366     Serial.println(\textcolor{stringliteral}{" "});
00367 
00368 
00369 \}
00370 
\Hypertarget{_cool_m_q_t_t_8cpp_source_l00375}\hyperlink{class_cool_m_q_t_t_a373cc92fca7760d886f02d8a6e5b3f63}{00375} String \hyperlink{class_cool_m_q_t_t_a373cc92fca7760d886f02d8a6e5b3f63}{CoolMQTT::getUser}()
00376 \{
00377     \textcolor{keywordflow}{return} String(user);
00378 \}
\end{DoxyCode}
